<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aditor AI Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg flex items-center justify-center font-bold text-xl">
            A
          </div>
          <div>
            <h1 class="text-xl font-bold">Aditor AI Studio</h1>
            <p class="text-sm text-gray-400">Self-Hosted Image & Video Generation</p>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-400">Status</div>
          <div class="flex items-center space-x-2">
            <span id="status-indicator" class="w-2 h-2 bg-gray-500 rounded-full"></span>
            <span id="status-text" class="text-sm font-medium">Checking...</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Mode Toggle -->
  <div class="bg-gray-800 border-b border-gray-700">
    <div class="container mx-auto px-6">
      <div class="flex space-x-1">
        <button id="tab-images" class="tab-btn active px-6 py-4 font-semibold text-sm border-b-2 border-primary-500 text-white">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>Images</span>
          </div>
        </button>
        <button id="tab-videos" class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-gray-400 hover:text-white">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <span>Videos</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8">
    
    <!-- IMAGE SECTION -->
    <div id="section-images" class="section-content">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Image Generation</h2>
        <p class="text-gray-400">ComfyUI-powered workflows for product shots, marketing assets, and more</p>
      </div>

      <!-- Categories -->
      <div class="mb-8">
        <div class="flex space-x-2 overflow-x-auto pb-2">
          <button class="category-btn active px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap bg-primary-600 text-white" data-category="all">
            All
          </button>
          <button class="category-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap bg-gray-700 text-gray-300 hover:bg-gray-600" data-category="Product">
            Product
          </button>
          <button class="category-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap bg-gray-700 text-gray-300 hover:bg-gray-600" data-category="Marketing">
            Marketing
          </button>
          <button class="category-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap bg-gray-700 text-gray-300 hover:bg-gray-600" data-category="Creative">
            Creative
          </button>
        </div>
      </div>

      <!-- Workflows Grid -->
      <div id="workflows-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <p class="text-gray-400 col-span-full text-center py-8">Loading workflows...</p>
      </div>
    </div>

    <!-- VIDEO SECTION -->
    <div id="section-videos" class="section-content hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Video Generation</h2>
        <p class="text-gray-400">Powered by Google Veo 3 - Generate videos from prompts or ad scripts</p>
      </div>

      <!-- Video Generation Form -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Form Column -->
        <div class="lg:col-span-2">
          <div class="bg-gray-800 rounded-xl p-6">
            <form id="video-form" class="space-y-6">
              
              <!-- Input Mode Toggle -->
              <div class="flex space-x-3">
                <button type="button" id="prompt-mode-btn" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium">
                  Prompt
                </button>
                <button type="button" id="script-mode-btn" class="flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600">
                  Script
                </button>
              </div>

              <!-- Prompt Input -->
              <div id="prompt-input">
                <label class="block text-sm font-medium text-gray-300 mb-2">Video Prompt</label>
                <textarea 
                  id="prompt" 
                  rows="4" 
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 text-white placeholder-gray-400"
                  placeholder="Professional product shot, smooth camera zoom, well-lit studio..."
                ></textarea>
                <p class="text-xs text-gray-400 mt-2">Describe camera movements, lighting, and visual style</p>
              </div>

              <!-- Script Input (hidden by default) -->
              <div id="script-input" class="hidden">
                <label class="block text-sm font-medium text-gray-300 mb-2">Ad Script</label>
                <textarea 
                  id="script" 
                  rows="6" 
                  class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 text-white placeholder-gray-400"
                  placeholder="[Product shot]&#10;Introducing the new iPhone...&#10;[CTA]&#10;Available now"
                ></textarea>
                <p class="text-xs text-gray-400 mt-2">AI will extract visual cues and convert to video prompt</p>
              </div>

              <!-- Duration -->
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Duration</label>
                <div class="flex items-center space-x-4">
                  <input 
                    type="range" 
                    id="duration" 
                    min="5" 
                    max="30" 
                    value="5" 
                    class="flex-1"
                  >
                  <span id="duration-value" class="text-lg font-semibold text-primary-500 w-16 text-right">5s</span>
                </div>
                <p class="text-xs text-gray-400 mt-2">~$0.10 per 5 seconds</p>
              </div>

              <!-- Aspect Ratio -->
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Aspect Ratio</label>
                <div class="grid grid-cols-3 gap-3">
                  <button type="button" class="aspect-ratio-btn active px-4 py-3 bg-primary-600 border-2 border-primary-500 rounded-lg font-medium text-sm" data-ratio="9:16">
                    9:16<br><span class="text-xs">Vertical</span>
                  </button>
                  <button type="button" class="aspect-ratio-btn px-4 py-3 bg-gray-700 border-2 border-gray-600 rounded-lg font-medium text-sm hover:border-gray-500" data-ratio="16:9">
                    16:9<br><span class="text-xs text-gray-400">Horizontal</span>
                  </button>
                  <button type="button" class="aspect-ratio-btn px-4 py-3 bg-gray-700 border-2 border-gray-600 rounded-lg font-medium text-sm hover:border-gray-500" data-ratio="1:1">
                    1:1<br><span class="text-xs text-gray-400">Square</span>
                  </button>
                </div>
              </div>

              <!-- Submit Button -->
              <button 
                type="submit" 
                class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-4 rounded-lg transition-colors"
              >
                Generate Video
              </button>
            </form>
          </div>

          <!-- Active Job Status -->
          <div id="job-status" class="hidden bg-gray-800 rounded-xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Generating...</h3>
              <button id="cancel-job" class="text-sm text-gray-400 hover:text-white">Cancel</button>
            </div>
            
            <div class="mb-4">
              <div class="flex justify-between text-sm text-gray-400 mb-2">
                <span id="job-status-text">Processing</span>
                <span id="job-progress">0%</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all" style="width: 0%"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <div class="text-gray-400">Job ID</div>
                <div class="font-mono text-xs" id="job-id">-</div>
              </div>
              <div>
                <div class="text-gray-400">Elapsed</div>
                <div class="font-semibold" id="elapsed-time">0s</div>
              </div>
            </div>
          </div>

          <!-- Completed Video -->
          <div id="video-result" class="hidden bg-gray-800 rounded-xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Video Ready!</h3>
              <button id="generate-another" class="text-sm text-primary-500 hover:text-primary-400">New Video</button>
            </div>
            
            <div class="bg-black rounded-lg overflow-hidden mb-4">
              <video id="result-video" controls class="w-full"></video>
            </div>

            <div class="flex space-x-3">
              <a id="download-video" href="#" download class="flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 rounded-lg text-center">
                Download
              </a>
              <button id="copy-url" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg">
                Copy URL
              </button>
            </div>
          </div>
        </div>

        <!-- Info Column -->
        <div class="space-y-6">
          <!-- Cost Estimate Card -->
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="font-semibold mb-4">Estimate</h3>
            <div class="space-y-3">
              <div>
                <div class="text-sm text-gray-400">Cost</div>
                <div class="text-3xl font-bold text-primary-500">$<span id="cost-estimate">0.10</span></div>
              </div>
              <div>
                <div class="text-sm text-gray-400">Processing Time</div>
                <div class="text-xl font-semibold">~<span id="time-estimate">100</span>s</div>
              </div>
            </div>
          </div>

          <!-- Recent Videos -->
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="font-semibold mb-4">Recent Videos</h3>
            <div id="recent-videos" class="space-y-2">
              <p class="text-sm text-gray-400 text-center py-4">No videos yet</p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </main>

  <script>
    const API_BASE = window.location.origin;
    let currentVideoJobId = null;
    let pollInterval = null;
    let startTime = null;

    // Tab switching
    document.getElementById('tab-images').addEventListener('click', () => {
      switchTab('images');
    });

    document.getElementById('tab-videos').addEventListener('click', () => {
      switchTab('videos');
    });

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-primary-500', 'text-white');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      
      const activeTab = document.getElementById(`tab-${tab}`);
      activeTab.classList.add('active', 'border-primary-500', 'text-white');
      activeTab.classList.remove('border-transparent', 'text-gray-400');

      // Update sections
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(`section-${tab}`).classList.remove('hidden');

      // Load content if needed
      if (tab === 'images' && !window.workflowsLoaded) {
        loadWorkflows();
      } else if (tab === 'videos' && !window.videosLoaded) {
        loadRecentVideos();
        window.videosLoaded = true;
      }
    }

    // Check API status
    async function checkStatus() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        if (data.status === 'ok') {
          document.getElementById('status-indicator').className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
          document.getElementById('status-text').textContent = 'Online';
        }
      } catch (error) {
        document.getElementById('status-indicator').className = 'w-2 h-2 bg-red-500 rounded-full';
        document.getElementById('status-text').textContent = 'Offline';
      }
    }

    // Load workflows for image generation
    async function loadWorkflows() {
      try {
        const res = await fetch(`${API_BASE}/api/workflows`);
        const data = await res.json();
        
        const grid = document.getElementById('workflows-grid');
        if (!data.workflows || data.workflows.length === 0) {
          grid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">No workflows available</p>';
          return;
        }

        grid.innerHTML = data.workflows.map(workflow => `
          <div class="bg-gray-800 rounded-xl p-6 hover:bg-gray-750 cursor-pointer transition-colors workflow-card" data-category="${workflow.category}">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="text-lg font-semibold mb-1">${workflow.name}</h3>
                <p class="text-sm text-gray-400">${workflow.description}</p>
              </div>
              <span class="px-2 py-1 text-xs font-medium bg-primary-600 text-white rounded">${workflow.category}</span>
            </div>
            <button class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 rounded-lg transition-colors">
              Generate
            </button>
          </div>
        `).join('');

        window.workflowsLoaded = true;

      } catch (error) {
        console.error('Failed to load workflows:', error);
      }
    }

    // Category filtering for images
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-btn')) {
        const category = e.target.dataset.category;
        
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-primary-600', 'text-white');
          btn.classList.add('bg-gray-700', 'text-gray-300');
        });
        e.target.classList.add('active', 'bg-primary-600', 'text-white');
        e.target.classList.remove('bg-gray-700', 'text-gray-300');

        document.querySelectorAll('.workflow-card').forEach(card => {
          if (category === 'all' || card.dataset.category === category) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      }
    });

    // Video generation logic
    const promptModeBtn = document.getElementById('prompt-mode-btn');
    const scriptModeBtn = document.getElementById('script-mode-btn');
    const promptInput = document.getElementById('prompt-input');
    const scriptInput = document.getElementById('script-input');
    const durationSlider = document.getElementById('duration');
    const durationValue = document.getElementById('duration-value');
    const costEstimate = document.getElementById('cost-estimate');
    const timeEstimate = document.getElementById('time-estimate');
    const videoForm = document.getElementById('video-form');

    // Toggle input mode
    promptModeBtn.addEventListener('click', () => {
      promptModeBtn.className = 'flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium';
      scriptModeBtn.className = 'flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600';
      promptInput.classList.remove('hidden');
      scriptInput.classList.add('hidden');
    });

    scriptModeBtn.addEventListener('click', () => {
      scriptModeBtn.className = 'flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium';
      promptModeBtn.className = 'flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg font-medium hover:bg-gray-600';
      scriptInput.classList.remove('hidden');
      promptInput.classList.add('hidden');
    });

    // Update estimates
    durationSlider.addEventListener('input', (e) => {
      const duration = parseInt(e.target.value);
      durationValue.textContent = `${duration}s`;
      const cost = (duration / 5) * 0.10;
      costEstimate.textContent = cost.toFixed(2);
      const time = duration * 20;
      timeEstimate.textContent = time;
    });

    // Aspect ratio selection
    document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.aspect-ratio-btn').forEach(b => {
          b.className = 'aspect-ratio-btn px-4 py-3 bg-gray-700 border-2 border-gray-600 rounded-lg font-medium text-sm hover:border-gray-500';
        });
        btn.className = 'aspect-ratio-btn active px-4 py-3 bg-primary-600 border-2 border-primary-500 rounded-lg font-medium text-sm';
      });
    });

    // Form submission
    videoForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const isScriptMode = !scriptInput.classList.contains('hidden');
      const prompt = document.getElementById('prompt').value.trim();
      const script = document.getElementById('script').value.trim();
      const duration = parseInt(durationSlider.value);
      const aspectRatio = document.querySelector('.aspect-ratio-btn.active').dataset.ratio;

      if (!isScriptMode && !prompt) {
        alert('Please enter a video prompt');
        return;
      }

      if (isScriptMode && !script) {
        alert('Please enter an ad script');
        return;
      }

      try {
        const payload = isScriptMode 
          ? { script, duration, aspectRatio }
          : { prompt, duration, aspectRatio };

        const res = await fetch(`${API_BASE}/api/video/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Generation failed');
        }

        currentVideoJobId = data.jobId;
        startTime = Date.now();
        document.getElementById('job-id').textContent = data.jobId;
        document.getElementById('job-status').classList.remove('hidden');
        document.getElementById('video-result').classList.add('hidden');

        pollVideoJob();

      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    // Poll video job
    async function pollVideoJob() {
      if (!currentVideoJobId) return;

      try {
        const res = await fetch(`${API_BASE}/api/video/status/${currentVideoJobId}`);
        const data = await res.json();

        const progress = data.progress || 0;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('job-progress').textContent = `${Math.round(progress)}%`;
        document.getElementById('job-status-text').textContent = data.status;

        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('elapsed-time').textContent = `${elapsed}s`;

        if (data.status === 'completed') {
          showVideo(data.videoUrl);
          stopPolling();
        } else if (data.status === 'failed') {
          alert(`Generation failed: ${data.error}`);
          stopPolling();
          document.getElementById('job-status').classList.add('hidden');
        } else {
          if (!pollInterval) {
            pollInterval = setInterval(pollVideoJob, 3000);
          }
        }

      } catch (error) {
        console.error('Poll error:', error);
      }
    }

    function showVideo(videoUrl) {
      document.getElementById('result-video').src = videoUrl;
      document.getElementById('download-video').href = videoUrl;
      document.getElementById('job-status').classList.add('hidden');
      document.getElementById('video-result').classList.remove('hidden');
      loadRecentVideos();
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    document.getElementById('cancel-job').addEventListener('click', () => {
      stopPolling();
      currentVideoJobId = null;
      document.getElementById('job-status').classList.add('hidden');
    });

    document.getElementById('generate-another').addEventListener('click', () => {
      document.getElementById('video-result').classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('copy-url').addEventListener('click', () => {
      const videoUrl = document.getElementById('result-video').src;
      navigator.clipboard.writeText(videoUrl);
      alert('Video URL copied!');
    });

    async function loadRecentVideos() {
      try {
        const res = await fetch(`${API_BASE}/api/video?limit=5`);
        const data = await res.json();
        
        const container = document.getElementById('recent-videos');
        
        if (!data.jobs || data.jobs.length === 0) {
          container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No videos yet</p>';
          return;
        }

        container.innerHTML = data.jobs.map(job => `
          <div class="p-3 bg-gray-700 rounded-lg text-sm">
            <div class="font-medium truncate mb-1">${(job.params.prompt || job.params.originalScript || '').substring(0, 40)}...</div>
            <div class="text-xs ${job.status === 'completed' ? 'text-green-500' : job.status === 'failed' ? 'text-red-500' : 'text-yellow-500'}">
              ${job.status}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load recent videos:', error);
      }
    }

    // Initialize
    checkStatus();
    loadWorkflows();
  </script>

</body>
</html>
