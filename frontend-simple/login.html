<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - Aditor Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #08080c; --card: #0f0f14; --border: #232330;
      --text: #ffffff; --text-dim: #8b8b9e;
      --accent: #f97316; --accent-hover: #ea580c;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .login-container { width: 100%; max-width: 420px; padding: 24px; }
    .logo { text-align: center; margin-bottom: 48px; }
    .logo-icon {
      width: 56px; height: 56px;
      background: linear-gradient(135deg, var(--accent) 0%, #c2410c 100%);
      border-radius: 16px; display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 24px; margin-bottom: 16px;
    }
    .logo h1 { font-size: 24px; font-weight: 700; }
    .logo p { color: var(--text-dim); font-size: 14px; margin-top: 8px; }
    .login-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 40px 32px;
    }
    .login-card h2 { font-size: 20px; font-weight: 600; margin-bottom: 8px; text-align: center; }
    .login-card .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 28px; text-align: center; }

    /* Google button wrapper */
    .google-wrapper { display: flex; justify-content: center; margin-bottom: 4px; }

    /* Divider */
    .divider {
      display: flex; align-items: center; gap: 16px;
      margin: 24px 0; color: var(--text-dim); font-size: 12px;
    }
    .divider::before, .divider::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    /* Code input */
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text-dim); margin-bottom: 8px; }
    .code-input {
      width: 100%; padding: 14px 16px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 12px;
      color: var(--text); font-size: 16px; font-family: 'Inter', monospace;
      font-weight: 600; letter-spacing: 2px; text-transform: uppercase;
      text-align: center; outline: none; transition: border-color 0.2s;
    }
    .code-input:focus { border-color: var(--accent); }
    .code-input::placeholder { color: #3a3a4a; font-weight: 400; letter-spacing: 1px; text-transform: none; }
    .submit-btn {
      width: 100%; padding: 14px; background: var(--accent); color: white;
      border: none; border-radius: 12px; font-size: 15px; font-weight: 600;
      font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.2s;
    }
    .submit-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .msg {
      padding: 12px 16px; border-radius: 10px; font-size: 13px;
      margin-bottom: 20px; display: none; text-align: center;
    }
    .msg.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
    .msg.success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; }
    .msg.show { display: block; }

    .footer { text-align: center; margin-top: 24px; color: var(--text-dim); font-size: 12px; }
  </style>
</head>
<body>

<div class="login-container">
  <div class="logo">
    <div class="logo-icon">A</div>
    <h1>Aditor Studio</h1>
    <p>AI-powered creative suite</p>
  </div>

  <div class="login-card">
    <h2>Welcome</h2>
    <p class="subtitle">Sign in to continue</p>

    <div id="error" class="msg error"></div>
    <div id="success" class="msg success"></div>

    <!-- Google Sign-In -->
    <div class="google-wrapper" id="google-section">
      <div id="google-btn"></div>
    </div>

    <div class="divider">or use invite code</div>

    <!-- Invite Code -->
    <form id="code-form">
      <div class="input-group">
        <input type="text" id="code" class="code-input" placeholder="Enter invite code" autocomplete="off" spellcheck="false" required>
      </div>
      <button type="submit" class="submit-btn" id="submit-btn">Continue</button>
    </form>
  </div>

  <div class="footer"><p>&copy; 2026 Aditor Inc.</p></div>
</div>

<script>
  const errorEl = document.getElementById('error');
  const successEl = document.getElementById('success');

  function showMsg(type, text) {
    const el = type === 'error' ? errorEl : successEl;
    el.textContent = text;
    el.classList.add('show');
    (type === 'error' ? successEl : errorEl).classList.remove('show');
  }

  function hideMsg() { errorEl.classList.remove('show'); successEl.classList.remove('show'); }

  async function completeLogin(data) {
    if (data.token) {
      localStorage.setItem('gen-token', data.token);
      localStorage.setItem('gen-user', JSON.stringify(data.user));
    }
    showMsg('success', 'Welcome, ' + data.user.name + '! Redirecting...');
    setTimeout(() => { window.location.href = '/'; }, 600);
  }

  // === Google Sign-In ===
  async function handleGoogleSignIn(response) {
    hideMsg();
    try {
      const res = await fetch('/api/auth/google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ credential: response.credential })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Sign in failed');
      completeLogin(data);
    } catch (err) {
      showMsg('error', err.message);
    }
  }

  // Init Google button
  window.addEventListener('load', async () => {
    // Get client ID from server
    try {
      const cfg = await fetch('/api/auth/config').then(r => r.json());
      if (cfg.google_client_id && window.google && google.accounts) {
        google.accounts.id.initialize({
          client_id: cfg.google_client_id,
          callback: handleGoogleSignIn
        });
        google.accounts.id.renderButton(document.getElementById('google-btn'), {
          theme: 'filled_black', size: 'large', width: 356, text: 'signin_with', shape: 'pill'
        });
      }
    } catch (e) {
      // Google button won't show, invite code still works
    }
  });

  // === Invite Code ===
  const form = document.getElementById('code-form');
  const submitBtn = document.getElementById('submit-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMsg();
    const code = document.getElementById('code').value.trim();
    if (!code) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Verifying...';

    try {
      const res = await fetch('/api/auth/code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ code })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Invalid code');
      completeLogin(data);
    } catch (err) {
      showMsg('error', err.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Continue';
    }
  });

  // === Auto-login from URL ===
  (async function() {
    try {
      const r = await fetch('/api/auth/me', { credentials: 'include' });
      if (r.ok) { window.location.href = '/'; return; }
    } catch (e) {}

    const code = new URLSearchParams(window.location.search).get('code');
    if (code) {
      document.getElementById('code').value = code;
      form.dispatchEvent(new Event('submit'));
    }
  })();
</script>

</body>
</html>
